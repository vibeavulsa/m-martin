rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    /**
     * Verifica se o usuário atual é um administrador autenticado.
     * 
     * IMPORTANTE: Esta implementação simplificada considera qualquer usuário 
     * autenticado como admin. Isso é adequado APENAS para desenvolvimento/testes.
     * 
     * PARA PRODUÇÃO, VOCÊ DEVE implementar uma das seguintes opções:
     * 
     * Opção 1 - Custom Claims (RECOMENDADO):
     *   function isAdmin() {
     *     return request.auth != null && request.auth.token.admin == true;
     *   }
     * 
     * Opção 2 - Lista de UIDs específicos:
     *   function isAdmin() {
     *     return request.auth != null && 
     *            request.auth.uid in ['uid-admin-1', 'uid-admin-2'];
     *   }
     * 
     * Sem essa mudança, QUALQUER usuário autenticado terá privilégios de admin!
     */
    function isAdmin() {
      return request.auth != null;
      // TODO: Substituir por verificação real de admin antes de produção
    }
    
    /**
     * Verifica se os dados possuem todos os campos obrigatórios de um pedido.
     */
    function hasRequiredOrderFields(data) {
      return data.keys().hasAll(['totalPrice', 'items', 'customer']);
    }
    
    /**
     * Verifica se o total do pedido é um número positivo e se items não está vazio.
     */
    function isValidTotal(data) {
      return data.totalPrice is number 
        && data.totalPrice > 0
        && data.items is list
        && data.items.size() > 0;
    }
    
    /**
     * Verifica se a atualização é apenas uma decrementação válida de estoque.
     * Usado para permitir que transações de pedido decrementem o estoque.
     */
    function isValidStockDecrement(before, after) {
      return after.quantity >= 0
        && after.quantity < before.quantity
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['quantity']);
    }
    
    // ============================================
    // COLEÇÃO: products
    // ============================================
    /**
     * Regras para a coleção de produtos:
     * - Leitura: Pública (qualquer usuário pode ver o catálogo)
     * - Criação/Exclusão: Apenas Admin autenticado
     * - Atualização (Admin): Acesso total
     * - Atualização (Transação): Permite decrementar estoque durante checkout
     * 
     * SEGURANÇA CRÍTICA: Clientes não podem modificar price, name, description
     * 
     * NOTA DE SEGURANÇA: A regra de atualização pública permite decrementos de estoque
     * durante transações de checkout. Para produção, considere:
     * 1. Usar Cloud Functions para gerenciar estoque (mais seguro)
     * 2. Implementar rate limiting
     * 3. Adicionar validações adicionais no código do servidor
     */
    match /products/{productId} {
      // Leitura: Pública - qualquer um pode ver produtos
      allow read: if true;
      
      // Criação e exclusão: Somente Admin
      allow create, delete: if isAdmin();
      
      // Atualização: Admin tem acesso total OU é uma decrementação válida de estoque
      allow update: if isAdmin() || isValidStockDecrement(resource.data, request.resource.data);
    }
    
    // ============================================
    // COLEÇÃO: orders
    // ============================================
    /**
     * Regras para a coleção de pedidos:
     * - Criação: Pública (qualquer um pode criar um pedido/comprar)
     * - Validação: Campos obrigatórios (totalPrice, items, customer) e total positivo
     * - Leitura: ESTRITA - Apenas Admin pode ler pedidos
     * - Atualização/Exclusão: Apenas Admin pode editar ou deletar pedidos
     * 
     * SEGURANÇA: Clientes não podem ler pedidos de outros usuários
     */
    match /orders/{orderId} {
      // Criação: Pública com validações obrigatórias
      allow create: if hasRequiredOrderFields(request.resource.data)
        && isValidTotal(request.resource.data);
      
      // Leitura: Apenas Admin pode ler todos os pedidos
      allow read: if isAdmin();
      
      // Atualização e exclusão: Apenas Admin
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // COLEÇÃO: categories
    // ============================================
    /**
     * Regras para a coleção de categorias:
     * - Leitura: Pública
     * - Escrita: Apenas Admin
     */
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // COLEÇÃO: cushionKit
    // ============================================
    /**
     * Regras para a configuração do kit de almofadas:
     * - Leitura: Pública
     * - Escrita: Apenas Admin
     */
    match /cushionKit/{kitId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
